# =============================================================================
# Supervisor Configuration for MultinotesAI
# =============================================================================
#
# Usage:
#   1. Copy to /etc/supervisor/conf.d/multinotesai.conf
#   2. Update paths and user as needed
#   3. Run: supervisorctl reread && supervisorctl update
#
# Commands:
#   supervisorctl status                  # Check status
#   supervisorctl restart multinotesai:*  # Restart all processes
#   supervisorctl tail -f gunicorn        # View logs
# =============================================================================

[group:multinotesai]
programs=gunicorn,daphne,celery_worker,celery_beat

# =============================================================================
# Gunicorn (WSGI Server)
# =============================================================================
[program:gunicorn]
command=/var/www/multinotesai/venv/bin/gunicorn backend.wsgi:application
    --bind unix:/var/run/multinotesai/gunicorn.sock
    --workers 4
    --worker-class gthread
    --threads 4
    --worker-tmp-dir /dev/shm
    --timeout 300
    --graceful-timeout 30
    --keep-alive 5
    --max-requests 1000
    --max-requests-jitter 50
    --access-logfile /var/log/multinotesai/gunicorn_access.log
    --error-logfile /var/log/multinotesai/gunicorn_error.log
    --capture-output
directory=/var/www/multinotesai/backend
user=www-data
group=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/multinotesai/gunicorn.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=
    DJANGO_SETTINGS_MODULE="backend.settings",
    PYTHONUNBUFFERED="1"

# =============================================================================
# Daphne (ASGI Server for WebSocket/SSE)
# =============================================================================
[program:daphne]
command=/var/www/multinotesai/venv/bin/daphne
    -b 127.0.0.1
    -p 8001
    --access-log /var/log/multinotesai/daphne_access.log
    backend.asgi:application
directory=/var/www/multinotesai/backend
user=www-data
group=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/multinotesai/daphne.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=
    DJANGO_SETTINGS_MODULE="backend.settings",
    PYTHONUNBUFFERED="1"

# =============================================================================
# Celery Worker (Background Tasks)
# =============================================================================
[program:celery_worker]
command=/var/www/multinotesai/venv/bin/celery -A backend worker
    --loglevel=INFO
    --concurrency=4
    --max-tasks-per-child=1000
    -Q default,high_priority,low_priority
directory=/var/www/multinotesai/backend
user=www-data
group=www-data
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=600
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/multinotesai/celery_worker.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=
    DJANGO_SETTINGS_MODULE="backend.settings",
    PYTHONUNBUFFERED="1",
    C_FORCE_ROOT="true"

# =============================================================================
# Celery Beat (Scheduled Tasks)
# =============================================================================
[program:celery_beat]
command=/var/www/multinotesai/venv/bin/celery -A backend beat
    --loglevel=INFO
    --scheduler django_celery_beat.schedulers:DatabaseScheduler
directory=/var/www/multinotesai/backend
user=www-data
group=www-data
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=30
redirect_stderr=true
stdout_logfile=/var/log/multinotesai/celery_beat.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
environment=
    DJANGO_SETTINGS_MODULE="backend.settings",
    PYTHONUNBUFFERED="1"
